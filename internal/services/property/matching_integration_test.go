//go:build integration
// +build integration

package property

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"math"
	"net/http"
	"testing"
	"time"
)

const mlServiceURL = "https://calcifer0323-matching.hf.space"

// EmbeddingRequest - –∑–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —ç–º–±–µ–¥–¥–∏–Ω–≥–∞
type EmbeddingRequest struct {
	Title       string `json:"title,omitempty"`
	Description string `json:"description,omitempty"`
}

// EmbeddingResponse - –æ—Ç–≤–µ—Ç —Å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–º
type EmbeddingResponse struct {
	Embedding    []float64 `json:"embedding"`
	Dimensions   int       `json:"dimensions"`
	PreparedText string    `json:"prepared_text"`
}

// getEmbedding –ø–æ–ª—É—á–∞–µ—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥ –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ ML —Å–µ—Ä–≤–∏—Å–∞
func getEmbedding(title, description string) ([]float64, error) {
	req := EmbeddingRequest{
		Title:       title,
		Description: description,
	}

	body, err := json.Marshal(req)
	if err != nil {
		return nil, fmt.Errorf("failed to marshal request: %w", err)
	}

	httpReq, err := http.NewRequest(http.MethodPost, mlServiceURL+"/prepare-and-embed", bytes.NewBuffer(body))
	if err != nil {
		return nil, fmt.Errorf("failed to create request: %w", err)
	}
	httpReq.Header.Set("Content-Type", "application/json")

	client := &http.Client{Timeout: 60 * time.Second}
	resp, err := client.Do(httpReq)
	if err != nil {
		return nil, fmt.Errorf("failed to send request: %w", err)
	}
	defer resp.Body.Close()

	if resp.StatusCode != http.StatusOK {
		return nil, fmt.Errorf("unexpected status code: %d", resp.StatusCode)
	}

	var result EmbeddingResponse
	if err := json.NewDecoder(resp.Body).Decode(&result); err != nil {
		return nil, fmt.Errorf("failed to decode response: %w", err)
	}

	return result.Embedding, nil
}

// cosineSimilarity –≤—ã—á–∏—Å–ª—è–µ—Ç –∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ –º–µ–∂–¥—É –¥–≤—É–º—è –≤–µ–∫—Ç–æ—Ä–∞–º–∏
func cosineSimilarity(a, b []float64) float64 {
	if len(a) != len(b) {
		return 0
	}

	var dotProduct, normA, normB float64
	for i := range a {
		dotProduct += a[i] * b[i]
		normA += a[i] * a[i]
		normB += b[i] * b[i]
	}

	if normA == 0 || normB == 0 {
		return 0
	}

	return dotProduct / (math.Sqrt(normA) * math.Sqrt(normB))
}

// TestRealMatchingWithDifferentCities - —Ä–µ–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç
// –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–±–ª–µ–º—É: –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥–∞ —Å—Ö–æ–¥—Å—Ç–≤–æ –ø–∞–¥–∞–µ—Ç –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ
func TestRealMatchingWithDifferentCities(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping integration test in short mode")
	}

	ctx := context.Background()
	_ = ctx // –¥–ª—è –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

	// –õ–∏–¥: –∏—â–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—É –≤ –ú–æ—Å–∫–≤–µ
	leadTitle := "–ò—â—É 2-–∫–æ–º–Ω–∞—Ç–Ω—É—é –∫–≤–∞—Ä—Ç–∏—Ä—É"
	leadDescription := "–ù—É–∂–Ω–∞ —Å–≤–µ—Ç–ª–∞—è 2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ –ú–æ—Å–∫–≤—ã, —Ä—è–¥–æ–º —Å –º–µ—Ç—Ä–æ, –±—é–¥–∂–µ—Ç –¥–æ 15 –º–ª–Ω —Ä—É–±–ª–µ–π"

	// –û–±—ä–µ–∫—Ç 1: –∏–¥–µ–∞–ª—å–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ - –≤ –ú–æ—Å–∫–≤–µ
	property1Title := "2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ"
	property1Description := "–°–≤–µ—Ç–ª–∞—è 2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ –ú–æ—Å–∫–≤—ã, 5 –º–∏–Ω—É—Ç –æ—Ç –º–µ—Ç—Ä–æ, 14.5 –º–ª–Ω —Ä—É–±–ª–µ–π"

	// –û–±—ä–µ–∫—Ç 2: —Ç–æ –∂–µ —Å–∞–º–æ–µ, –Ω–æ –≤ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–µ
	property2Title := "2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ"
	property2Description := "–°–≤–µ—Ç–ª–∞—è 2-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ —Ü–µ–Ω—Ç—Ä–µ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞, 5 –º–∏–Ω—É—Ç –æ—Ç –º–µ—Ç—Ä–æ, 14.5 –º–ª–Ω —Ä—É–±–ª–µ–π"

	// –û–±—ä–µ–∫—Ç 3: —Å–æ–≤—Å–µ–º –¥—Ä—É–≥–æ–π - –æ—Ñ–∏—Å –≤ –ú–æ—Å–∫–≤–µ
	property3Title := "–û—Ñ–∏—Å–Ω–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ"
	property3Description := "–û—Ñ–∏—Å 100 –∫–≤.–º –≤ –±–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä–µ –ú–æ—Å–∫–≤—ã, –æ—Ç–ª–∏—á–Ω—ã–π —Ä–µ–º–æ–Ω—Ç, 50 –º–ª–Ω —Ä—É–±–ª–µ–π"

	t.Log("=== –¢–ï–°–¢: –†–µ–∞–ª—å–Ω–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–∞—Ç—á–∏–Ω–≥–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –≥–æ—Ä–æ–¥–∞–º–∏ ===")
	t.Log("")

	// –ü–æ–ª—É—á–∞–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥–∏
	t.Log("–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ —á–µ—Ä–µ–∑ ML —Å–µ—Ä–≤–∏—Å...")
	t.Log("")

	leadEmbedding, err := getEmbedding(leadTitle, leadDescription)
	if err != nil {
		t.Fatalf("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥ –ª–∏–¥–∞: %v", err)
	}
	t.Logf("‚úì –õ–∏–¥: '%s'", leadTitle)
	t.Logf("  –û–ø–∏—Å–∞–Ω–∏–µ: %s", leadDescription)
	t.Log("")

	property1Embedding, err := getEmbedding(property1Title, property1Description)
	if err != nil {
		t.Fatalf("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ 1: %v", err)
	}
	t.Logf("‚úì –û–±—ä–µ–∫—Ç 1 (–ú–æ—Å–∫–≤–∞): '%s'", property1Title)
	t.Logf("  –û–ø–∏—Å–∞–Ω–∏–µ: %s", property1Description)

	property2Embedding, err := getEmbedding(property2Title, property2Description)
	if err != nil {
		t.Fatalf("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ 2: %v", err)
	}
	t.Logf("‚úì –û–±—ä–µ–∫—Ç 2 (–°–ü–±): '%s'", property2Title)
	t.Logf("  –û–ø–∏—Å–∞–Ω–∏–µ: %s", property2Description)

	property3Embedding, err := getEmbedding(property3Title, property3Description)
	if err != nil {
		t.Fatalf("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ 3: %v", err)
	}
	t.Logf("‚úì –û–±—ä–µ–∫—Ç 3 (–û—Ñ–∏—Å): '%s'", property3Title)
	t.Logf("  –û–ø–∏—Å–∞–Ω–∏–µ: %s", property3Description)
	t.Log("")

	// –í—ã—á–∏—Å–ª—è–µ–º —Å—Ö–æ–¥—Å—Ç–≤–æ
	similarity1 := cosineSimilarity(leadEmbedding, property1Embedding)
	similarity2 := cosineSimilarity(leadEmbedding, property2Embedding)
	similarity3 := cosineSimilarity(leadEmbedding, property3Embedding)

	t.Log("=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ë–ï–ó –§–ò–õ–¨–¢–†–ê –ü–û –ì–û–†–û–î–£ ===")
	t.Log("")
	t.Logf("üìä –°—Ö–æ–¥—Å—Ç–≤–æ —Å –æ–±—ä–µ–∫—Ç–æ–º –≤ –ú–û–°–ö–í–ï (–ö–≤–∞—Ä—Ç–∏—Ä–∞):        %.2f%% ", similarity1*100)
	t.Logf("üìä –°—Ö–æ–¥—Å—Ç–≤–æ —Å –æ–±—ä–µ–∫—Ç–æ–º –≤ –°–ü–ë (–ö–≤–∞—Ä—Ç–∏—Ä–∞):           %.2f%% ", similarity2*100)
	t.Logf("üìä –°—Ö–æ–¥—Å—Ç–≤–æ —Å –æ–±—ä–µ–∫—Ç–æ–º –≤ –ú–û–°–ö–í–ï (–û—Ñ–∏—Å):            %.2f%% ", similarity3*100)
	t.Log("")

	// –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
	diffCities := similarity1 - similarity2
	diffType := similarity1 - similarity3

	t.Log("=== –ê–ù–ê–õ–ò–ó ===")
	t.Log("")
	t.Logf("‚ö†Ô∏è  –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –ú–æ—Å–∫–≤–æ–π –∏ –°–ü–±: %.2f –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤", diffCities*100)
	t.Logf("   –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∫–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –°–ü–ë –ø–æ—á—Ç–∏ —Ç–∞–∫ –∂–µ '–ø–æ–¥—Ö–æ–¥–∏—Ç' –∫–∞–∫ –≤ –ú–æ—Å–∫–≤–µ!")
	t.Log("")
	t.Logf("‚úì  –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –∫–≤–∞—Ä—Ç–∏—Ä–æ–π –∏ –æ—Ñ–∏—Å–æ–º: %.2f –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤", diffType*100)
	t.Logf("   –û—Ñ–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏–º–µ–µ—Ç –±–æ–ª–µ–µ –Ω–∏–∑–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥")
	t.Log("")

	t.Log("=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –° –ñ–Å–°–¢–ö–ò–ú –§–ò–õ–¨–¢–†–û–ú –ü–û –ì–û–†–û–î–£ ===")
	t.Log("")

	// –°–∏–º—É–ª–∏—Ä—É–µ–º –∂—ë—Å—Ç–∫–∏–π —Ñ–∏–ª—å—Ç—Ä
	leadCity := "–ú–æ—Å–∫–≤–∞"
	property1City := "–ú–æ—Å–∫–≤–∞"
	property2City := "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥"
	property3City := "–ú–æ—Å–∫–≤–∞"

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≥–æ—Ä–æ–¥–æ–≤
	match1 := citiesMatch(leadCity, property1City)
	match2 := citiesMatch(leadCity, property2City)
	match3 := citiesMatch(leadCity, property3City)

	t.Logf("–õ–∏–¥ –∏—â–µ—Ç –≤ –≥–æ—Ä–æ–¥–µ: %s", leadCity)
	t.Log("")

	if match1 {
		t.Logf("‚úÖ –û–±—ä–µ–∫—Ç 1 (–ú–æ—Å–∫–≤–∞, –ö–≤–∞—Ä—Ç–∏—Ä–∞): –ü–†–û–•–û–î–ò–¢ —Ñ–∏–ª—å—Ç—Ä ‚Üí —Å—Ö–æ–¥—Å—Ç–≤–æ %.2f%%", similarity1*100)
	} else {
		t.Logf("‚ùå –û–±—ä–µ–∫—Ç 1 (–ú–æ—Å–∫–≤–∞, –ö–≤–∞—Ä—Ç–∏—Ä–∞): –ù–ï –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ñ–∏–ª—å—Ç—Ä ‚Üí –û–¢–§–ò–õ–¨–¢–†–û–í–ê–ù")
	}

	if match2 {
		t.Logf("‚úÖ –û–±—ä–µ–∫—Ç 2 (–°–ü–±, –ö–≤–∞—Ä—Ç–∏—Ä–∞): –ü–†–û–•–û–î–ò–¢ —Ñ–∏–ª—å—Ç—Ä ‚Üí —Å—Ö–æ–¥—Å—Ç–≤–æ %.2f%%", similarity2*100)
	} else {
		t.Logf("‚ùå –û–±—ä–µ–∫—Ç 2 (–°–ü–±, –ö–≤–∞—Ä—Ç–∏—Ä–∞): –ù–ï –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ñ–∏–ª—å—Ç—Ä ‚Üí –û–¢–§–ò–õ–¨–¢–†–û–í–ê–ù")
	}

	if match3 {
		t.Logf("‚úÖ –û–±—ä–µ–∫—Ç 3 (–ú–æ—Å–∫–≤–∞, –û—Ñ–∏—Å): –ü–†–û–•–û–î–ò–¢ —Ñ–∏–ª—å—Ç—Ä ‚Üí —Å—Ö–æ–¥—Å—Ç–≤–æ %.2f%%", similarity3*100)
	} else {
		t.Logf("‚ùå –û–±—ä–µ–∫—Ç 3 (–ú–æ—Å–∫–≤–∞, –û—Ñ–∏—Å): –ù–ï –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ñ–∏–ª—å—Ç—Ä ‚Üí –û–¢–§–ò–õ–¨–¢–†–û–í–ê–ù")
	}

	t.Log("")
	t.Log("=== –í–´–í–û–î ===")
	t.Log("")
	t.Log("–ë–µ–∑ –∂—ë—Å—Ç–∫–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –≥–æ—Ä–æ–¥—É:")
	t.Logf("  - –ö–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –°–ü–± –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ö–æ–¥—Å—Ç–≤–æ %.2f%% (–ø—Ä–æ–±–ª–µ–º–∞!)", similarity2*100)
	t.Log("")
	t.Log("–° –∂—ë—Å—Ç–∫–∏–º —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –≥–æ—Ä–æ–¥—É:")
	t.Log("  - –ö–≤–∞—Ä—Ç–∏—Ä–∞ –≤ –°–ü–± –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è")
	t.Log("  - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã –≤ —Å–≤–æ—ë–º –≥–æ—Ä–æ–¥–µ")
	t.Log("")

	// –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è CI
	if similarity2 > 0.85 {
		t.Log("‚ö†Ô∏è  –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û: –ë–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –æ–±—ä–µ–∫—Ç –∏–∑ –¥—Ä—É–≥–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –∏–º–µ–µ—Ç –≤—ã—Å–æ–∫–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ (>85%)")
	}

	if !match2 {
		t.Log("‚úÖ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û: –ñ—ë—Å—Ç–∫–∏–π —Ñ–∏–ª—å—Ç—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Å–µ–∏–≤–∞–µ—Ç –æ–±—ä–µ–∫—Ç –∏–∑ –¥—Ä—É–≥–æ–≥–æ –≥–æ—Ä–æ–¥–∞")
	}
}

// citiesMatch –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤ (—É–ø—Ä–æ—â—ë–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
func citiesMatch(city1, city2 string) bool {
	return normalizeCity(city1) == normalizeCity(city2)
}

// normalizeCity –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞
func normalizeCity(city string) string {
	cityAliases := map[string]string{
		"–º—Å–∫":              "–ú–æ—Å–∫–≤–∞",
		"moscow":           "–ú–æ—Å–∫–≤–∞",
		"—Å–ø–±":              "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
		"–ø–∏—Ç–µ—Ä":            "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
		"—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥":  "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
		"saint-petersburg": "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥",
	}

	lower := string(bytes.ToLower([]byte(city)))
	if normalized, ok := cityAliases[lower]; ok {
		return normalized
	}
	return city
}

// TestRealMatchingSameDescriptionDifferentCity –±–æ–ª–µ–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç
func TestRealMatchingSameDescriptionDifferentCity(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping integration test in short mode")
	}

	t.Log("=== –¢–ï–°–¢: –ê–±—Å–æ–ª—é—Ç–Ω–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, —Ä–∞–∑–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ ===")
	t.Log("")

	// –ë–∞–∑–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–µ–∑ –≥–æ—Ä–æ–¥–∞
	baseDescription := "–ü—Ä–æ—Å—Ç–æ—Ä–Ω–∞—è 3-–∫–æ–º–Ω–∞—Ç–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞, 80 –∫–≤.–º, —Å–≤–µ–∂–∏–π —Ä–µ–º–æ–Ω—Ç, —Ä—è–¥–æ–º –ø–∞—Ä–∫ –∏ —à–∫–æ–ª–∞"

	// –õ–∏–¥ –∏—â–µ—Ç –≤ –ú–æ—Å–∫–≤–µ
	leadTitle := "–ò—â—É –∫–≤–∞—Ä—Ç–∏—Ä—É"
	leadDesc := baseDescription + ", –ú–æ—Å–∫–≤–∞"

	// –û–±—ä–µ–∫—Ç –≤ –ú–æ—Å–∫–≤–µ
	prop1Title := "–ö–≤–∞—Ä—Ç–∏—Ä–∞"
	prop1Desc := baseDescription + ", –ú–æ—Å–∫–≤–∞"

	// –û–±—ä–µ–∫—Ç –≤ –°–ü–± (–≤—Å—ë —Ç–æ –∂–µ, —Ç–æ–ª—å–∫–æ –≥–æ—Ä–æ–¥ –¥—Ä—É–≥–æ–π)
	prop2Title := "–ö–≤–∞—Ä—Ç–∏—Ä–∞"
	prop2Desc := baseDescription + ", –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥"

	t.Log("–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥–∏...")

	leadEmb, err := getEmbedding(leadTitle, leadDesc)
	if err != nil {
		t.Fatalf("–û—à–∏–±–∫–∞: %v", err)
	}

	prop1Emb, err := getEmbedding(prop1Title, prop1Desc)
	if err != nil {
		t.Fatalf("–û—à–∏–±–∫–∞: %v", err)
	}

	prop2Emb, err := getEmbedding(prop2Title, prop2Desc)
	if err != nil {
		t.Fatalf("–û—à–∏–±–∫–∞: %v", err)
	}

	sim1 := cosineSimilarity(leadEmb, prop1Emb)
	sim2 := cosineSimilarity(leadEmb, prop2Emb)

	t.Log("")
	t.Logf("–õ–∏–¥: '%s'", leadDesc)
	t.Log("")
	t.Logf("–û–±—ä–µ–∫—Ç 1 (–ú–æ—Å–∫–≤–∞): '%s'", prop1Desc)
	t.Logf("  ‚Üí –°—Ö–æ–¥—Å—Ç–≤–æ: %.2f%%", sim1*100)
	t.Log("")
	t.Logf("–û–±—ä–µ–∫—Ç 2 (–°–ü–±): '%s'", prop2Desc)
	t.Logf("  ‚Üí –°—Ö–æ–¥—Å—Ç–≤–æ: %.2f%%", sim2*100)
	t.Log("")

	diff := (sim1 - sim2) * 100
	t.Logf("–†–∞–∑–Ω–∏—Ü–∞: %.2f –ø—Ä–æ—Ü–µ–Ω—Ç–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤", diff)
	t.Log("")

	if diff < 10 {
		t.Logf("‚ö†Ô∏è  –†–∞–∑–Ω–∏—Ü–∞ –º–µ–Ω–µ–µ 10%% - –æ–±—ä–µ–∫—Ç –∏–∑ –¥—Ä—É–≥–æ–≥–æ –≥–æ—Ä–æ–¥–∞ —Å–ª–∏—à–∫–æ–º '–±–ª–∏–∑–æ–∫'!")
		t.Log("   –≠—Ç–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –∂—ë—Å—Ç–∫–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –≥–æ—Ä–æ–¥—É")
	}
}

// TestRealMatchingWithDifferentPropertyTypes - —Ç–µ—Å—Ç —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–∏–ø—É –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
// –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–±–ª–µ–º—É: –∫–≤–∞—Ä—Ç–∏—Ä–∞ –∏ –æ—Ñ–∏—Å –º–æ–≥—É—Ç –∏–º–µ—Ç—å –≤—ã—Å–æ–∫–æ–µ —Å—Ö–æ–¥—Å—Ç–≤–æ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞
func TestRealMatchingWithDifferentPropertyTypes(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping integration test in short mode")
	}

	t.Log("=== –¢–ï–°–¢: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø—É –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ ===")
	t.Log("")

	// –õ–∏–¥: –∏—â–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—É
	leadTitle := "–ò—â—É –∫–≤–∞—Ä—Ç–∏—Ä—É"
	leadDesc := "–ù—É–∂–Ω–æ –∂–∏–ª—å—ë 60 –∫–≤.–º –≤ –ú–æ—Å–∫–≤–µ, —Ö–æ—Ä–æ—à–∏–π —Ä–µ–º–æ–Ω—Ç, —Ä—è–¥–æ–º —Å –ø–∞—Ä–∫–æ–º"

	// –û–±—ä–µ–∫—Ç 1: –ö–≤–∞—Ä—Ç–∏—Ä–∞
	prop1Title := "–ö–≤–∞—Ä—Ç–∏—Ä–∞"
	prop1Desc := "–£—é—Ç–Ω–æ–µ –∂–∏–ª—å—ë 65 –∫–≤.–º –≤ –ú–æ—Å–∫–≤–µ, —Å–≤–µ–∂–∏–π —Ä–µ–º–æ–Ω—Ç, —Ä—è–¥–æ–º –ø–∞—Ä–∫"
	prop1Type := "APARTMENT"

	// –û–±—ä–µ–∫—Ç 2: –û—Ñ–∏—Å (–ø–æ—Ö–æ–∂–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ!)
	prop2Title := "–û—Ñ–∏—Å"
	prop2Desc := "–ü–æ–º–µ—â–µ–Ω–∏–µ 60 –∫–≤.–º –≤ –ú–æ—Å–∫–≤–µ, —Ö–æ—Ä–æ—à–∏–π —Ä–µ–º–æ–Ω—Ç, —Ä—è–¥–æ–º —Å –ø–∞—Ä–∫–æ–º"
	prop2Type := "COMMERCIAL"

	// –û–±—ä–µ–∫—Ç 3: –î–æ–º
	prop3Title := "–î–æ–º"
	prop3Desc := "–ñ–∏–ª—å—ë 150 –∫–≤.–º –≤ –ú–æ—Å–∫–≤–µ, –æ—Ç–ª–∏—á–Ω—ã–π —Ä–µ–º–æ–Ω—Ç, —Å–≤–æ–π —É—á–∞—Å—Ç–æ–∫"
	prop3Type := "HOUSE"

	t.Log("–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥–∏...")

	leadEmb, err := getEmbedding(leadTitle, leadDesc)
	if err != nil {
		t.Fatalf("–û—à–∏–±–∫–∞: %v", err)
	}

	prop1Emb, err := getEmbedding(prop1Title, prop1Desc)
	if err != nil {
		t.Fatalf("–û—à–∏–±–∫–∞: %v", err)
	}

	prop2Emb, err := getEmbedding(prop2Title, prop2Desc)
	if err != nil {
		t.Fatalf("–û—à–∏–±–∫–∞: %v", err)
	}

	prop3Emb, err := getEmbedding(prop3Title, prop3Desc)
	if err != nil {
		t.Fatalf("–û—à–∏–±–∫–∞: %v", err)
	}

	sim1 := cosineSimilarity(leadEmb, prop1Emb)
	sim2 := cosineSimilarity(leadEmb, prop2Emb)
	sim3 := cosineSimilarity(leadEmb, prop3Emb)

	t.Log("")
	t.Log("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
	t.Log("‚ïë       –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ë–ï–ó –§–ò–õ–¨–¢–†–ê –ü–û –¢–ò–ü–£ –ù–ï–î–í–ò–ñ–ò–ú–û–°–¢–ò             ‚ïë")
	t.Log("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£")
	t.Logf("‚ïë –õ–∏–¥ –∏—â–µ—Ç: –ö–í–ê–†–¢–ò–†–£                                            ‚ïë")
	t.Log("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£")
	t.Logf("‚ïë –ö–≤–∞—Ä—Ç–∏—Ä–∞:   —Å—Ö–æ–¥—Å—Ç–≤–æ %.2f%%                                   ‚ïë", sim1*100)
	t.Logf("‚ïë –û—Ñ–∏—Å:       —Å—Ö–æ–¥—Å—Ç–≤–æ %.2f%%  ‚Üê –ú–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã—Å–æ–∫–∏–º!            ‚ïë", sim2*100)
	t.Logf("‚ïë –î–æ–º:        —Å—Ö–æ–¥—Å—Ç–≤–æ %.2f%%                                   ‚ïë", sim3*100)
	t.Log("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
	t.Log("")

	// –°–∏–º—É–ª–∏—Ä—É–µ–º –∂—ë—Å—Ç–∫–∏–π —Ñ–∏–ª—å—Ç—Ä
	leadType := "APARTMENT"

	t.Log("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
	t.Log("‚ïë       –†–ï–ó–£–õ–¨–¢–ê–¢–´ –° –§–ò–õ–¨–¢–†–û–ú –ü–û –¢–ò–ü–£ –ù–ï–î–í–ò–ñ–ò–ú–û–°–¢–ò              ‚ïë")
	t.Log("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£")
	t.Logf("‚ïë –õ–∏–¥ –∏—â–µ—Ç —Ç–∏–ø: %s                                         ‚ïë", leadType)
	t.Log("‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£")

	if prop1Type == leadType {
		t.Logf("‚ïë ‚úÖ –ö–≤–∞—Ä—Ç–∏—Ä–∞ (%s): –ü–†–û–•–û–î–ò–¢ ‚Üí %.2f%%                    ‚ïë", prop1Type, sim1*100)
	} else {
		t.Logf("‚ïë ‚ùå –ö–≤–∞—Ä—Ç–∏—Ä–∞ (%s): –û–¢–§–ò–õ–¨–¢–†–û–í–ê–ù–ê                        ‚ïë", prop1Type)
	}

	if prop2Type == leadType {
		t.Logf("‚ïë ‚úÖ –û—Ñ–∏—Å (%s): –ü–†–û–•–û–î–ò–¢ ‚Üí %.2f%%                       ‚ïë", prop2Type, sim2*100)
	} else {
		t.Logf("‚ïë ‚ùå –û—Ñ–∏—Å (%s): –û–¢–§–ò–õ–¨–¢–†–û–í–ê–ù                            ‚ïë", prop2Type)
	}

	if prop3Type == leadType {
		t.Logf("‚ïë ‚úÖ –î–æ–º (%s): –ü–†–û–•–û–î–ò–¢ ‚Üí %.2f%%                             ‚ïë", prop3Type, sim3*100)
	} else {
		t.Logf("‚ïë ‚ùå –î–æ–º (%s): –û–¢–§–ò–õ–¨–¢–†–û–í–ê–ù                                  ‚ïë", prop3Type)
	}

	t.Log("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
	t.Log("")

	t.Log("=== –í–´–í–û–î ===")
	t.Log("")
	if sim2 > 0.7 {
		t.Logf("‚ö†Ô∏è  –û—Ñ–∏—Å –∏–º–µ–µ—Ç —Å—Ö–æ–¥—Å—Ç–≤–æ %.2f%% - –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ–ø–∞–ª –±—ã –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã!", sim2*100)
	}
	t.Log("‚úÖ –ñ—ë—Å—Ç–∫–∏–π —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏—Å–∫–ª—é—á–∞–µ—Ç –Ω–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã")
	t.Log("")
}
