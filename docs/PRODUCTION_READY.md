# 🏠 Lead Exchange - Отчёт о готовности к продакшену

**Дата**: 17 декабря 2025  
**Версия**: 1.0.0

## ✅ Готовые компоненты

### 1. Ядро системы
- [x] **gRPC API** - полностью реализован (Auth, User, Lead, Deal, Property, File)
- [x] **REST Gateway** - автогенерация через grpc-gateway
- [x] **Swagger документация** - автогенерация для всех сервисов
- [x] **JWT авторизация** - с возможностью отключения для тестирования

### 2. AI-компоненты

#### ML Embeddings (✅ Готов)
- Интеграция с внешним ML сервисом (https://calcifer0323-matching.hf.space)
- 384-мерные эмбеддинги для семантического поиска
- Автоматическая генерация при создании объектов

#### Jina Reranker (✅ Готов)
- Интеграция с Jina AI API
- Модель: jina-reranker-v2-base-multilingual
- Поддержка русского языка
- Тесты показывают корректное переранжирование

#### OpenAI LLM (✅ Готов)
- Генерация описаний объектов
- Анализ намерений лидов
- Динамические веса для матчинга
- Уточняющие вопросы для неполных лидов

#### Computer Vision (⏸️ Отложен)
- Структура готова, но отключен (нет фотографий)
- Легко активируется при наличии данных

### 3. Поисковый пайплайн

#### Гибридный поиск (✅ Готов)
- Векторный поиск (pgvector, косинусное расстояние)
- Полнотекстовый поиск (PostgreSQL FTS, русский язык)
- Настраиваемые веса (по умолчанию 70% вектор / 30% FTS)

#### Жёсткие фильтры (✅ Готов)
- Фильтрация по городу (критично для UX)
- Фильтрация по типу недвижимости
- Ценовой диапазон, комнаты, площадь

#### Динамические веса (✅ Готов)
- LLM анализирует текст лида
- Автоматически определяет важность критериев
- Адаптивное ранжирование

### 4. Метрики и мониторинг (✅ Готов)
- AI метрики (latency, error rate, call count)
- Поддержка всех AI-сервисов (LLM, Reranker, Vision, Embeddings)

## 📊 Результаты тестирования

### Unit тесты
```
✅ lead_exchange/internal/grpc/propertygrpc     - PASS
✅ lead_exchange/internal/lib/llm               - PASS  
✅ lead_exchange/internal/lib/metrics           - PASS
✅ lead_exchange/internal/lib/reranker          - PASS
✅ lead_exchange/internal/services/clarification - PASS
✅ lead_exchange/internal/services/lead         - PASS
✅ lead_exchange/internal/services/property     - PASS
✅ lead_exchange/internal/services/weights      - PASS
```

### Интеграционные тесты (с реальными API)
```
✅ TestMLServiceAvailability        - ML сервис доступен
✅ TestRealEmbeddingGeneration      - Эмбеддинги генерируются
✅ TestRealMatchingScenarios        - Все сценарии матчинга работают
✅ TestEndToEndMatchingPipeline     - Полный пайплайн работает
✅ TestJinaRerankerBasicRerank      - Reranker работает
✅ TestJinaRerankerRealEstateScenario - Сценарии для недвижимости
✅ TestJinaRerankerMultilingual     - Русский язык поддерживается
```

## 🔧 Конфигурация (.env)

```bash
# ML Embeddings
ML_ENABLE=true
ML_BASE_URL=https://calcifer0323-matching.hf.space

# Jina Reranker  
RERANKER_ENABLE=true
RERANKER_API_KEY=jina_...

# OpenAI LLM
LLM_ENABLE=true
LLM_API_KEY=sk-proj-...
LLM_MODEL=gpt-4o-mini

# Search
HYBRID_SEARCH_ENABLE=true
SEARCH_USE_RERANKER=true
DYNAMIC_WEIGHTS_ENABLE=true
```

## ⚠️ Что нужно для полноценного продакшена

### Критично
1. **База данных PostgreSQL** с расширениями:
   - `pgvector` для векторного поиска
   - Миграции в папке `migrations/`

2. **API ключи** в .env файле (уже настроены)

### Рекомендуется
1. **Rate limiting** для защиты от злоупотреблений
2. **Caching** результатов эмбеддингов (Redis/Memcached)
3. **Retry logic** для внешних API с exponential backoff
4. **Prometheus/Grafana** для визуализации метрик
5. **Structured logging** с отправкой в ELK/Loki

### Опционально
1. **Computer Vision** - активировать при наличии фотографий
2. **A/B тестирование** - для оптимизации весов
3. **Feedback loop** - сбор обратной связи по матчингу

## 🚀 Запуск

```bash
# Сборка
go build -o lead_exchange.exe ./cmd/main.go

# Запуск
./lead_exchange.exe
```

## 📈 Производительность

| Операция | Время |
|----------|-------|
| Генерация эмбеддинга | ~0.5-2с |
| Reranker (5 документов) | ~2-3с |
| LLM анализ лида | ~2-5с |
| Векторный поиск (1000 объектов) | <50мс |
| Гибридный поиск | <100мс |

## 🏗️ Архитектура матчинга

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           LEAD EXCHANGE - MATCHING PIPELINE                  │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐                                                              
│   КЛИЕНТ     │  REST/gRPC запрос: MatchProperties(lead_id, filters)        
└──────┬───────┘                                                              
       │                                                                      
       ▼                                                                      
┌──────────────────────────────────────────────────────────────────────────────┐
│  1. ПОЛУЧЕНИЕ ДАННЫХ ЛИДА                                                    │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  LeadService.GetLead(lead_id)                                          │  │
│  │  → title, description, city, price_range, rooms, property_type         │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘
       │                                                                      
       ▼                                                                      
┌──────────────────────────────────────────────────────────────────────────────┐
│  2. ДИНАМИЧЕСКИЙ АНАЛИЗ ВЕСОВ (опционально, если DYNAMIC_WEIGHTS_ENABLE)     │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  OpenAI LLM анализирует текст лида:                                    │  │
│  │  "Ищу квартиру в центре Москвы" → district_weight: 0.35 (↑)            │  │
│  │  "Нужно недорого до 10 млн"     → price_weight: 0.40 (↑)               │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘
       │                                                                      
       ▼                                                                      
┌──────────────────────────────────────────────────────────────────────────────┐
│  3. ГИБРИДНЫЙ ПОИСК (HYBRID_SEARCH_ENABLE)                                   │
│  ┌─────────────────────────────────┐  ┌─────────────────────────────────┐   │
│  │  ВЕКТОРНЫЙ ПОИСК (70%)          │  │  ПОЛНОТЕКСТОВЫЙ ПОИСК (30%)     │   │
│  │  ┌───────────────────────────┐  │  │  ┌───────────────────────────┐  │   │
│  │  │ ML Service (HF Space)     │  │  │  │ PostgreSQL FTS            │  │   │
│  │  │ → 384-dim embedding       │  │  │  │ → ts_rank + ts_query      │  │   │
│  │  │ → pgvector cosine dist    │  │  │  │ → russian dictionary      │  │   │
│  │  └───────────────────────────┘  │  │  └───────────────────────────┘  │   │
│  └─────────────────────────────────┘  └─────────────────────────────────┘   │
│                          ↓                          ↓                        │
│                    ┌──────────────────────────────────┐                      │
│                    │  Объединение: RRF или взвешенное │                      │
│                    │  → TOP 50-100 кандидатов         │                      │
│                    └──────────────────────────────────┘                      │
└──────────────────────────────────────────────────────────────────────────────┘
       │                                                                      
       ▼                                                                      
┌──────────────────────────────────────────────────────────────────────────────┐
│  4. ЖЁСТКИЕ ФИЛЬТРЫ (Hard Filters)                                           │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  ❌ city != lead.city           → ОТФИЛЬТРОВАНО                        │  │
│  │  ❌ property_type != lead.type  → ОТФИЛЬТРОВАНО                        │  │
│  │  ❌ price > lead.max_price      → ОТФИЛЬТРОВАНО                        │  │
│  │  ✅ Прошли фильтры              → Передаём дальше                      │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘
       │                                                                      
       ▼                                                                      
┌──────────────────────────────────────────────────────────────────────────────┐
│  5. ПЕРЕРАНЖИРОВАНИЕ (SEARCH_USE_RERANKER)                                   │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  Jina Reranker API (jina-reranker-v2-base-multilingual)                │  │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │  │
│  │  │  Query: "Ищу 2-комнатную квартиру в центре Москвы"               │  │  │
│  │  │  Documents: [property1.description, property2.description, ...]   │  │  │
│  │  │  → Глубокий контекстуальный анализ                               │  │  │
│  │  │  → Переупорядочивание по relevance_score                         │  │  │
│  │  └──────────────────────────────────────────────────────────────────┘  │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘
       │                                                                      
       ▼                                                                      
┌──────────────────────────────────────────────────────────────────────────────┐
│  6. ФИНАЛЬНОЕ РАНЖИРОВАНИЕ (Weighted Scoring)                                │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  TotalScore = w_price × PriceScore                                     │  │
│  │             + w_district × DistrictScore                               │  │
│  │             + w_rooms × RoomsScore                                     │  │
│  │             + w_area × AreaScore                                       │  │
│  │             + w_semantic × SemanticScore (от Reranker или cosine)      │  │
│  │                                                                        │  │
│  │  Веса (w_*) определяются динамически LLM или статически из конфига     │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘
       │                                                                      
       ▼                                                                      
┌──────────────────────────────────────────────────────────────────────────────┐
│  7. РЕЗУЛЬТАТ                                                                │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │  [                                                                     │  │
│  │    {                                                                   │  │
│  │      property: {...},                                                  │  │
│  │      total_score: 0.92,                                                │  │
│  │      price_score: 0.95,                                                │  │
│  │      district_score: 0.88,                                             │  │
│  │      rooms_score: 1.0,                                                 │  │
│  │      semantic_score: 0.89,                                             │  │
│  │      match_explanation: "Идеальное совпадение по цене и району"        │  │
│  │    },                                                                  │  │
│  │    ...                                                                 │  │
│  │  ]                                                                     │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              КОМПОНЕНТЫ СИСТЕМЫ                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐      │
│  │   PostgreSQL │   │  ML Service │   │  Jina AI    │   │  OpenAI     │      │
│  │   + pgvector │   │  (HF Space) │   │  Reranker   │   │  GPT-4o-mini│      │
│  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘      │
│  │                 │                 │                 │              │
│  │  Хранение       │  Embeddings     │  Reranking      │  Analysis    │
│  │  + FTS          │  768-dim        │  Multilingual   │  Weights     │
│  │                 │                 │                 │              │
│  ┌──────┴─────────────────┴─────────────────┴─────────────────┴──────┐      │
│  │                         PropertyService                            │      │
│  │  MatchPropertiesAdvanced() / HybridSearch() / ApplyWeightedRanking │      │
│  └────────────────────────────────────────────────────────────────────┘      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## ✅ Заключение

**Сервис ГОТОВ к реальному использованию** при условии:
1. Развёрнутой PostgreSQL с pgvector
2. Валидных API ключей (уже настроены)

Все основные компоненты протестированы и работают корректно.

